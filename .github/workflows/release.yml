name: Release

on:
  push:
    branches: [main] # switch to tags: ['v*'] if you prefer tag-driven releases

permissions:
  contents: write

jobs:
  release:
    strategy:
      matrix:
        os: [macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      CSC_IDENTITY_AUTO_DISCOVERY: false # no mac signing
      CSC_FOR_PULL_REQUEST: true
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install deps (retry)
        shell: bash
        env:
          ELECTRON_MIRROR: https://github.com/electron/electron/releases/download/
        run: |
          attempts=0
          until bun install --frozen-lockfile; do
            attempts=$((attempts+1))
            if [ $attempts -ge 3 ]; then
              echo "bun install failed after $attempts attempts."
              exit 1
            fi
            echo "bun install failed (attempt $attempts), retrying in 10s..."
            sleep 10
          done

      - name: Build frontend and backend
        shell: bash
        run: |
          cd frontend && bun run build
          cd ../backend && bun run build
          cd ../desktop && bun run build
          cd ..

      - name: Package and publish desktop
        uses: samuelmeuli/action-electron-builder@v1
        with:
          app_root: desktop
          github_token: ${{ secrets.GITHUB_TOKEN }}
          release: true
          build_script_name: dist
